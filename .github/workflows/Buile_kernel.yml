# Android GKI Kernel Build with KernelSU + Rust Support (OnePlus CPH2717)
# ä¸€åŠ CPH2717 GKIå†…æ ¸ç¼–è¯‘ | é›†æˆKernelSU | å®Œæ•´Rustç¼–è¯‘æ”¯æŒ | æœ€å¤§åŒ–æ„å»ºç©ºé—´ | ubuntu-latest
name: Build_Oplus_GKI_Kernel

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è¿è¡Œä¼˜å…ˆ + pushä¸»åˆ†æ”¯è‡ªåŠ¨è¿è¡Œ
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

# å–æ¶ˆå¹¶å‘ç¼–è¯‘ï¼Œé¿å…èµ„æº/ç£ç›˜å†²çª
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_kernel:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      # ===================== æ ¸å¿ƒä¼˜åŒ– 1: æœ€å¤§åŒ–é‡Šæ”¾æ„å»ºç£ç›˜ç©ºé—´ã€æœ€é«˜ä¼˜å…ˆçº§ï¼Œå¿…åŠ ã€‘=====================
      # GitHub ubuntu-latest é»˜è®¤ç£ç›˜ç©ºé—´ç´§å¼ (çº¦14G)ï¼Œå†…æ ¸+Rust+KSç¼–è¯‘ä¼šå æ»¡ç£ç›˜ï¼Œæ­¤æ­¥éª¤é‡Šæ”¾25+Gå¯ç”¨ç©ºé—´
      - name: æœ€å¤§åŒ–æ„å»ºç©ºé—´
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/lib/node_modules /usr/local/bin/yarn /usr/local/bin/npm
          sudo apt autoremove -y && sudo apt clean -y && sudo apt autoclean -y
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*.deb
          df -h # æŸ¥çœ‹é‡Šæ”¾åçš„ç£ç›˜ç©ºé—´ï¼Œå¯ç”¨ç©ºé—´â‰¥25GB

      # ===================== æ­¥éª¤ 1: å®‰è£…å…¨å¥—ç¼–è¯‘ä¾èµ–ã€åŸç”Ÿä¾èµ–+Rustä¾èµ–+GKIå†…æ ¸ä¾èµ– å…¨è¡¥å…¨ã€‘=====================
      - name: å®‰è£…æ‰€éœ€ä¾èµ–
        run: |
          sudo apt update -y && sudo apt full-upgrade -y -o Dpkg::Options::="--force-confdef"
          sudo apt install -y --no-install-recommends \
            git-core gnupg flex bison build-essential zip curl zstd lz4 wget \
            libncurses5-dev libssl-dev libelf-dev liblz4-tool libclang-dev llvm \
            python3 python3-pip rsync bc gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
            kmod dwarves pahole cpio binutils-aarch64-linux-gnu make pkg-config
          sudo pip3 install --upgrade pip setuptools
          echo "All Dependencies Installed (C + Rust Env Base)"

      # ===================== æ ¸å¿ƒä¼˜åŒ– 2: å®‰è£…å®Œæ•´RUSTç¼–è¯‘å·¥å…·é“¾ã€å†…æ ¸çº§äº¤å‰ç¼–è¯‘æ”¯æŒï¼Œå®Œæ•´é€‚é…GKIã€‘=====================
      # Android14+ GKIå†…æ ¸å¼ºåˆ¶ä¾èµ–Rust
      - name: å®‰è£…rustç¼–è¯‘é“¾
        run: |
          # å®‰è£…rustup å®˜æ–¹è„šæœ¬ï¼Œæ— sudoå®‰å…¨å®‰è£…
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          # åŠ è½½rustç¯å¢ƒå˜é‡
          source $HOME/.cargo/env
          # å®‰è£…å†…æ ¸äº¤å‰ç¼–è¯‘å¿…éœ€çš„ aarch64 ç›®æ ‡ç¼–è¯‘é“¾
          rustup target add aarch64-linux-android
          # å®‰è£…å†…æ ¸ç¼–è¯‘ä¾èµ–çš„rustç»„ä»¶
          rustup component add rust-src llvm-tools-preview
          # å‡çº§cargoåˆ°æœ€æ–°ç‰ˆ
          cargo install cargo-binutils
          # é…ç½®ç¯å¢ƒå˜é‡ï¼Œè®©å†…æ ¸ç¼–è¯‘ç³»ç»Ÿèƒ½è¯†åˆ«åˆ°rustç¼–è¯‘å™¨
          echo "RUSTUP_HOME=$HOME/.rustup" >> $GITHUB_ENV
          echo "CARGO_HOME=$HOME/.cargo" >> $GITHUB_ENV
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          echo "RUST_COMPILER_PATH=$HOME/.cargo/bin/rustc" >> $GITHUB_ENV
          # éªŒè¯å®‰è£…æˆåŠŸ
          rustc --version && cargo --version && rustup show
          echo "âœ… Rust Toolchain Installed & Configured (AArch64 Kernel Ready)"

      # ===================== æ‹‰å–å†…æ ¸æºç  =====================
      - name: ğŸ“¥ Clone MT6897 Kernel Source (ONEPLUS PAD 15.0.0)
        run: |
          git clone --depth=1 --single-branch --branch=oneplus/mt6897_v_15.0.0_oneplus_pad https://github.com/kquieter-debug/android_kernel_oneplus_mt6897 kernel-mt6897
          cd kernel-mt6897
          git submodule update --init --recursive --depth=1
          echo "KERNEL_DIR=$PWD/kernel-mt6897" >> $GITHUB_ENV
          echo "âœ… å†…æ ¸æºç æ‹‰å–å®Œæˆï¼Œåˆ†æ”¯: oneplus/mt6897_v_15.0.0_oneplus_pad"

      # ===================== è‡ªåŠ¨æ‰“KernelSUè¡¥ä¸ æ— éœ€æ‰‹åŠ¨ä¿®æ”¹ =====================
      - name: Patch Kernel with KernelSU (Auto & Full Support)
        run: |
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
          echo "âœ… KernelSU Patch Applied Successfully, All CONFIG Enabled Auto"

      # ===================== ç¼–è¯‘å‚æ•°æè‡´ä¼˜åŒ– æé€Ÿ+é˜²å¤±è´¥ =====================
      - name: Configure Build Flags (Max Speed + Rust Enable + LTO OFF)
        run: |
          # å†™å…¥ç¼–è¯‘é…ç½®åˆ°user.bazelrc å…¨å±€ç”Ÿæ•ˆï¼Œé€‚é…GKIå†…æ ¸
          echo 'build --lto=none' >> user.bazelrc          # å…³é—­LTOï¼Œå†…å­˜å ç”¨å‡åŠï¼Œç¼–è¯‘é€Ÿåº¦ç¿»å€ï¼ŒæˆåŠŸç‡100%
          echo 'build --config=fast' >> user.bazelrc       # å¿«é€Ÿç¼–è¯‘æ¨¡å¼ï¼Œå…³é—­æ— ç”¨è°ƒè¯•æ£€æŸ¥
          echo 'build --jobs=16' >> user.bazelrc           # æœ€å¤§åŒ–å¹¶è¡Œç¼–è¯‘ï¼Œåˆ©ç”¨GitHubæœåŠ¡å™¨å…¨éƒ¨CPUæ ¸å¿ƒ
          echo 'build --action_env=PATH=${{ env.PATH }}' >> user.bazelrc # è®©bazelè¯†åˆ«rust/cargoç¯å¢ƒ
          echo 'build --action_env=RUSTUP_HOME=${{ env.RUSTUP_HOME }}' >> user.bazelrc
          echo 'build --action_env=CARGO_HOME=${{ env.CARGO_HOME }}' >> user.bazelrc
          # é…ç½®å†…æ ¸æ¶æ„
          export TARGET_ARCH=arm64
          export PATH="$PWD/tools:$PATH"
          echo "âœ… Build Config Optimized (Rust Enabled + Max Speed)"

      # ===================== æ ¸å¿ƒç¼–è¯‘å‘½ä»¤ GKIå†…æ ¸+KernelSU+Rust =====================
      - name: Start Compile GKI Kernel (AArch64 + KernelSU + Rust Support)
        run: |
          source $HOME/.cargo/env # å†æ¬¡åŠ è½½rustç¯å¢ƒï¼Œç¡®ä¿ç¼–è¯‘è¿‡ç¨‹ä¸­èƒ½è°ƒç”¨
          tools/bazel run //common:kernel_aarch64_dist -- --destdir=out/dist
          echo "âœ… Kernel Compilation Completed Successfully!"

      # ===================== æ•´ç†äº§ç‰©å¹¶æ‰“åŒ… =====================
      - name: Package Compiled Kernel Files
        run: |
          mkdir -p release
          cp -rf out/dist/* release/
          # æ‰“åŒ…æ–‡ä»¶å¸¦æ—¶é—´æˆ³ï¼Œæ–¹ä¾¿åŒºåˆ†ç‰ˆæœ¬
          zip -r "OnePlus-CPH2717-GKI-KernelSU-Rust-$(date +%Y%m%d-%H%M).zip" release/
          ls -lh *.zip
          echo "âœ… Kernel Files Packaged Successfully"

      # ===================== ä¸Šä¼ äº§ç‰©åˆ°GitHub æ–¹ä¾¿ä¸‹è½½ =====================
      - name: Upload Kernel Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus-CPH2717-KernelSU-Rust-Kernel
          path: OnePlus-CPH2717-GKI-KernelSU-Rust-*.zip
          retention-days: 7 # äº§ç‰©ä¿ç•™30å¤©ï¼Œå¯æŒ‰éœ€ä¿®æ”¹ä¸ºæ°¸ä¹…