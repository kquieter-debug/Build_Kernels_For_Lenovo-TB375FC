#############################
#   Written by Muffin_Joe   #
#############################
#     I wrote this sh*t     #
#############################
#    AI真是写得一坨好石啊！   #
#############################
name: 仅编译内核(Git Clone)

on:
  workflow_dispatch: # 手动触发工作流

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

      - name: 检出代码
        uses: actions/checkout@v3

      - name: 最大化构建空间
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 4096
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl \
            git \
            openjdk-11-jdk \
            wget \
            unzip \
            python3 \
            python3-pip \
            python3-setuptools \
            build-essential \
            ccache \
            zlib1g-dev \
            libncurses5-dev \
            libssl-dev \
            libxml2-utils \
            bc                #怎么写成这样...

      - name: 安装 Bazel
        run: |
          sudo apt install curl gnupg
          curl https://bazel.build/bazel-release.pub.gpg | sudo apt-key add -
          echo "deb [arch=amd64] https://storage.googleapis.com/bazel-apt stable jdk1.8" | sudo tee /etc/apt/sources.list.d/bazel.list
          sudo apt update && sudo apt install bazel
          sudo apt update && sudo apt full-upgrade
          bazel --version

      - name: 拉取内核源码
        run: |
          git clone -b oneplus/mt6897_b_16.0.0_nord_ce5 https://github.com/kquieter-debug/android_kernel_modules_and_devicetree_oneplus_mt6897.git oneplus_kernel
          cd oneplus_kernel
          echo "内核源码拉取完成"

      - name: 缓存 Bazel 构建和依赖
        uses: actions/cache@v3
        with:
          # 使用 Bazel 缓存目录
          path: |
            ~/.cache/bazel
            ~/.bazel-<user>-local
            oneplus_kernel/.bazel-out
          key: ${{ runner.os }}-bazel-${{ hashFiles('**/*.bazel*') }}
          restore-keys: |
            ${{ runner.os }}-bazel-

      - name: 使用 Bazel 构建内核
        run: |
          cd oneplus_kernel/kernel/kernel_device_modules-6.1
          # 使用 Bazel 构建内核
          bazel build //kernel:kernel_image

      - name: 上传结果
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: oneplus_kernel/kernel/arch/arm64/boot/Image.gz-dtb