#############################
#   Written by Muffin_Joe   #
#############################
#     I wrote this sh*t     #
#############################
#    AI真是写得一坨好石啊！   #
#############################
name: 仅编译内核

on:
  workflow_dispatch: # 手动触发工作流

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

      - name: 检出代码
        uses: actions/checkout@v3

      - name: 最大化构建空间
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 4096
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl build-essential git \
            openjdk-11-jdk \
            wget bison flex libssl-dev \
            unzip \
            python3 python3-pip python3-setuptools \
            build-essential \
            ccache \
            zlib1g-dev \
            libncurses5-dev libssl-dev libxml2-utils \
            bc                #怎么写成这样...

      - name: 拉取交叉编译链
        run: |
          git clone --depth 1 https://github.com/kdrag0n/proton-clang
          export PATH=$PATH:~/proton-clang/bin
          export CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- CLANG_TRIPLE=aarch64-linux-gnu-


      - name: 拉取内核源码
        run: |
          git clone -b oneplus/mt6897_b_16.0.0_nord_ce5 https://github.com/kquieter-debug/android_kernel_modules_and_devicetree_oneplus_mt6897.git oneplus_kernel
          cd oneplus_kernel/kernel
          mkdir -p prebuilts/build-tools
          git clone https://android.googlesource.com/platform/prebuilts/build-tools.git .
          echo "内核源码拉取完成"

      - name: 缓存 Bazel 构建和依赖
        uses: actions/cache@v3
        with:
          # 使用 Bazel 缓存目录
          path: |
            ~/.cache/bazel
            ~/.bazel-<user>-local
            oneplus_kernel/.bazel-out
          key: ${{ runner.os }}-bazel-${{ hashFiles('**/*.bazel*') }}
          restore-keys: |
            ${{ runner.os }}-bazel-

      - name: 使用 Bazel 构建内核
        run: |
          cd oneplus_kernel/kernel/kernel_device_modules-6.1
          # 使用 Bazel 构建内核
          export DIST_DIR="$GITHUB_WORKSPACE/kernel_build_output"
          mkdir -p "$DIST_DIR"
          tools/bazel run //common:kernel_aarch64_dist -- --destdir="$DIST_DIR"

      - name: 上传结果
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: ${{ github.workspace }}/kernel_build_output/