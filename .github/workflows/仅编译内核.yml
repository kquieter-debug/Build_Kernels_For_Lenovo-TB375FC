name: 仅编译内核

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      # 配置依赖
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential ccache curl flex \
            g++-multilib gcc-multilib git gnupg gperf \
            imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev \
            liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev \
            libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools \
            xsltproc zip zlib1g-dev \
            openjdk-17-jdk \
            python3 python3-pip \
            repo

      # 拉取内核源码仓库
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          repository: kquieter-debug/android_kernel_modules_and_devicetree_oneplus_mt6897
          ref: oneplus/mt6897_v_15.0.0_oneplus_pad
          path: kernel-source
            repo sync

      # 拉取当前仓库的编译脚本/配置
      - name: Checkout Build Configs
        uses: actions/checkout@v4
        with:
          path: build-configs
          
      - name: 打印完整目录结构（验证实际路径）
        run: |
            # 打印当前工作目录
            pwd
            # 打印根目录所有文件/目录（显示层级）
            ls -la
            # 递归打印目录结构（更清晰）
            find . -maxdepth 3 -type d  # 只显示3层目录，避免输出过多

      # 进入内核目录并执行编译
      - name: Build Kernel
        run: |
          cd "kernel-source repo sync/kernel"
          # 加载环境变量
          #source envsetup.sh
          # 执行编译脚本（根据你的仓库结构选择）
          #./build.sh
          # 或者如果是用 bazel 构建
          bazel build //kernel:kernel_aarch64

      # 上传编译产物
      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: |
            kernel-source/kernel/out/**/*.img
            kernel-source/kernel/out/**/*.dtb