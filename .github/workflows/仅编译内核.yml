# 工作流名称
name: 仅编译内核

# 触发方式：仅手动触发
on:
  workflow_dispatch:

# 定义任务
jobs:
  build_kernel:
    # 运行环境
    runs-on: ubuntu-latest
    # 任务超时时间：180分钟
    timeout-minutes: 180
    
    # 环境变量定义（全局）
    env:
      KERNEL_REPO: https://github.com/kquieter-debug/android_kernel_oneplus_mt6897.git
      KERNEL_BRANCH: oneplus/mt6897_v_15.0.0_oneplus_pad
      DIST_DIR: ${{ github.workspace }}/out/dist
      RUST_VERSION: 1.70.0
      # Bazel版本调整：6.4.0属于6.x LTS（维护阶段），标注版本类型便于维护
      BAZEL_VERSION: 6.4.0
      BAZEL_LTS_TRACK: 6.x  # 明确LTS轨道，便于后续升级
      LLVM_VERSION: llvmorg-20.1.0
      LLVM_SRC_DIR: ${{ github.workspace }}/llvm-project
      LLVM_INSTALL_DIR: ${{ github.workspace }}/llvm-install
    
    # 任务步骤
    steps:
      # 步骤1：检出当前仓库代码（基础步骤）
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 步骤2：安装基础依赖
      - name: 安装基础编译依赖
        run: |
          # 更新系统源并安装基础工具
          sudo apt update -y
          sudo apt install -y git python3 python3-pip flex bison cmake ninja-build \
                              libssl-dev liblzma-dev libncurses5-dev libxml2-dev \
                              pkg-config zip unzip zlib1g-dev wget curl
          # 清理缓存，避免依赖冲突
          sudo apt autoremove -y
          sudo apt clean

      # 步骤3：安装Bazel 6.4.0（按LTS规范调整，增加容错和验证）
      - name: 安装指定版本Bazel（6.x LTS，维护阶段）
        id: install_bazel
        continue-on-error: false  # 版本安装失败直接终止，避免后续无效编译
        run: |
          # 1. 添加Bazel官方源（适配LTS版本验证）
          sudo apt install -y apt-transport-https curl gnupg
          curl -fsSL https://bazel.build/bazel-release.pub.gpg | gpg --dearmor > bazel.gpg
          sudo mv bazel.gpg /etc/apt/trusted.gpg.d/
          # 明确指定stable轨道（LTS版本所在轨道），避免拉取滚动版本
          echo "deb [arch=amd64] https://storage.googleapis.com/bazel-apt stable jdk11" | sudo tee /etc/apt/sources.list.d/bazel.list
          
          # 2. 更新源并安装指定LTS版本
          sudo apt update -y
          # 强制指定版本安装，避免自动升级到非预期版本
          sudo apt install -y --no-install-recommends bazel-${{ env.BAZEL_VERSION }}
          
          # 3. 创建软链接，确保全局可用
          sudo ln -sf /usr/bin/bazel-${{ env.BAZEL_VERSION }} /usr/bin/bazel
          
          # 4. 严格验证版本（符合语义化版本规则）
          INSTALLED_VERSION=$(bazel --version | awk '{print $2}')
          if [ "$INSTALLED_VERSION" != "${{ env.BAZEL_VERSION }}" ]; then
            echo "错误：安装的Bazel版本为$INSTALLED_VERSION，预期为${{ env.BAZEL_VERSION }}"
            exit 1
          fi
          echo "✅ Bazel ${{ env.BAZEL_VERSION }}（${{ env.BAZEL_LTS_TRACK }} LTS）安装验证成功"
          bazel --version

      # 步骤4：Bazel构建规则兼容性检查（适配Android内核编译）
      - name: 检查Bazel规则兼容性
        run: |
          # 验证内核源码中Bazel规则与当前LTS版本兼容
          cd ${{ github.workspace }}/kernel || exit 1
          if [ -f "tools/bazel/WORKSPACE" ]; then
            # 检查WORKSPACE中是否指定了兼容的规则版本
            grep -q "bazel_version" tools/bazel/WORKSPACE && echo "✅ 内核Bazel规则包含版本声明" || echo "⚠️ 建议在tools/bazel/WORKSPACE中添加Bazel版本限制"
          fi
          # 预加载Bazel依赖，提前发现兼容性问题
          bazel fetch //common:kernel_aarch64 --distdir=${{ env.DIST_DIR }}

      # 步骤5：安装Rust 1.70.0编译链
      - name: 安装Rust工具链
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-linux-android
          components: rust-src, rustfmt, clippy
      # 配置Rust环境变量
      - name: 配置Rust环境
        run: |
          echo "RUSTUP_HOME=$HOME/.cargo" >> $GITHUB_ENV
          echo "CARGO_HOME=$HOME/.cargo" >> $GITHUB_ENV
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          # 验证Rust版本
          rustc --version
          cargo --version

      # 步骤6：拉取内核源码
      - name: 克隆内核源码
        run: |
          # 创建内核源码目录并克隆
          mkdir -p ${{ github.workspace }}/kernel
          cd ${{ github.workspace }}/kernel
          git clone -b ${{ env.KERNEL_BRANCH }} ${{ env.KERNEL_REPO }} .
          # 检查分支和关键文件
          git branch
          if [ -f "tools/bazel" ]; then
            echo "内核源码tools/bazel文件存在"
          else
            echo "警告：内核源码tools/bazel文件缺失"
            exit 1
          fi

      # 步骤7：下载并解压LLVM 20.1.0源码
      - name: 下载解压LLVM 20.1.0源码
        run: |
          # 创建LLVM工作目录
          mkdir -p ${{ env.LLVM_SRC_DIR }}
          cd ${{ env.LLVM_SRC_DIR }}
          # 下载官方源码包
          curl -LO https://github.com/llvm/llvm-project/releases/download/${{ env.LLVM_VERSION }}/llvm-project-20.1.0.src.tar.xz
          # 解压（先解xz，再解tar）
          unxz llvm-project-20.1.0.src.tar.xz
          tar -xf llvm-project-20.1.0.src.tar
          # 验证解压结果
          if [ -d "llvm-project-20.1.0.src/llvm" ]; then
            echo "LLVM源码解压成功"
          else
            echo "LLVM源码解压失败"
            exit 1
          fi

      # 步骤8：编译并安装LLVM/Clang 20.1.0
      - name: 编译安装LLVM/Clang
        run: |
          # 进入LLVM源码目录
          cd ${{ env.LLVM_SRC_DIR }}/llvm-project-20.1.0.src
          # 创建编译目录
          mkdir build && cd build
          # CMake配置（适配Android内核编译）
          cmake ../llvm -DCMAKE_BUILD_TYPE=Release \
                        -DLLVM_ENABLE_PROJECTS='clang' \
                        -DLLVM_ENABLE_RUNTIMES='compiler-rt;libcxx;libcxxabi;libunwind' \
                        -DLLVM_TARGETS_TO_BUILD='AArch64;X86' \
                        -DCMAKE_INSTALL_PREFIX=${{ env.LLVM_INSTALL_DIR }} \
                        -G Ninja
          # 编译（使用全部CPU核心加速）
          ninja -j$(nproc)
          # 安装到指定目录
          ninja install
          # 验证编译结果
          ${{ env.LLVM_INSTALL_DIR }}/bin/clang --version
          ${{ env.LLVM_INSTALL_DIR }}/bin/lld --version

      # 步骤9：配置Clang交叉编译环境
      - name: 配置Clang环境变量
        run: |
          # 将编译后的Clang加入PATH
          echo "${{ env.LLVM_INSTALL_DIR }}/bin" >> $GITHUB_PATH
          # 配置交叉编译环境变量（适配AArch64 Android内核）
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "LD=lld" >> $GITHUB_ENV
          # 验证环境
          clang --version
          lld --version

      # 步骤10：编译Android内核（Bazel方式，适配LTS版本）
      - name: 编译内核（使用Bazel 6.x LTS）
        run: |
          # 进入内核源码目录
          cd ${{ github.workspace }}/kernel
          # 创建输出目录
          mkdir -p ${{ env.DIST_DIR }}
          # 显式指定Bazel版本运行，避免环境变量冲突
          /usr/bin/bazel-${{ env.BAZEL_VERSION }} build //common:kernel_aarch64 --distdir=${{ env.DIST_DIR }}
          # 验证编译产物
          if [ -d "${{ env.DIST_DIR }}" ] && [ "$(ls -A ${{ env.DIST_DIR }})" ]; then
            echo "内核编译产物生成成功"
            ls -l ${{ env.DIST_DIR }}
          else
            echo "内核编译产物生成失败"
            exit 1
          fi

      # 步骤11：上传编译产物
      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build-output
          path: |
            ${{ env.DIST_DIR }}/**
            !${{ env.DIST_DIR }}/**/*.log  # 排除日志文件
          retention-days: 14  # 产物保留14天
          