#############################
#   Written by Muffin_Joe   #
#############################
#     I wrote this sh*t     #
#############################
#    AIçœŸæ˜¯å†™å¾—ä¸€å¨å¥½çŸ³å•Šï¼   #
#############################
name: ä»…ç¼–è¯‘å†…æ ¸

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

# å·¥ä½œæµä»»åŠ¡é…ç½®
jobs:
  build:
    # è¿è¡Œç¯å¢ƒï¼šUbuntu 22.04
    runs-on: ubuntu-22.04       #ä¸è¿‡ä¸ºä»€ä¹ˆä¸ç”¨latestå‘¢ï¼Ÿ
    # è®¾ç½®å…¨å±€ç¯å¢ƒå˜é‡
    env:
      KERNEL_REPO: kquieter-debug/android_kernel_modules_and_devicetree_oneplus_mt6897
      KERNEL_BRANCH: oneplus/mt6897_v_15.0.0_oneplus_pad
      KERNEL_SOURCE_DIR: ${{ github.workspace }}/kernel-source
      KERNEL_BUILD_DIR: ${{ github.workspace }}/kernel-source/kernel
      BAZEL_OUTPUT_DIR: ${{ github.workspace }}/kernel-source/bazel-out
      PYTHON3_PREBUILTS_PATH: ${{ github.workspace }}/kernel-source/kernel/prebuilts/build-tools/path/linux-x86/

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºGitHubä»“åº“ä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šç¼“å­˜ccache
      - name: è®¾ç½® ccache
        uses: actions/cache@v3
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      # æ­¥éª¤3ï¼šç¼“å­˜Bazel
      - name: è®¾ç½® Bazel Cache
        uses: actions/cache@v3
        with:
          path: ~/.cache/bazel
          key: ${{ runner.os }}-bazel-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-bazel-

      # æ­¥éª¤4ï¼šå®‰è£…å†…æ ¸ç¼–è¯‘ä¾èµ–
      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          set -euo pipefail  # å¼ºåŒ–é”™è¯¯æ£€æµ‹ï¼šæœªå®šä¹‰å˜é‡/ç®¡é“å¤±è´¥å‡ç»ˆæ­¢
          sudo apt update --fix-missing
          sudo apt upgrade -y
          # å®‰è£…å†…æ ¸ç¼–è¯‘æ ¸å¿ƒä¾èµ–
          sudo apt install -y -o DPkg::Options::="--force-confdef" \
            bc bison build-essential ccache curl flex \
            gcc-multilib git gnupg gperf \
            lib32ncurses5-dev lib32readline-dev lib32z1-dev \
            liblz4-tool libncurses5-dev libssl-dev \
            python3 python3-pip npm
          # å›ºå®šBazeliskç‰ˆæœ¬
          sudo npm install -g @bazel/bazelisk@v1.18.0
          echo "ğŸ” ç¯å¢ƒæ ¡éªŒ - Bazeliskç‰ˆæœ¬:$(bazelisk --version)"
          echo "ğŸ” ç¯å¢ƒæ ¡éªŒ - Python3ç‰ˆæœ¬:$(python3 --version)"
          echo "ğŸ” ç¯å¢ƒæ ¡éªŒ - GCCç‰ˆæœ¬:$(gcc --version | head -n1)"

          # è¾“å‡ºç‚¹ç§è´§
          echo -e "  \033[1;36mCharacter\033[0m: \033[1mæ›°\033[0m"  # æµ…è“æ ‡è¯†+ç²—ä½“â€œæ›°â€
          echo -e "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo -e "â”‚                 â”‚"
          echo -e "â”‚      \033[1;34mæ›°\033[0m      â”‚"  # è“è‰²ç²—ä½“çªå‡ºæ˜¾ç¤ºâ€œæ›°â€
          echo -e "â”‚                 â”‚"
          echo -e "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          #æˆ‘ä¸ºä»€ä¹ˆè¦å†™è¿™äº›ä¸œè¥¿

      # æ­¥éª¤5ï¼šæ‹‰å–å†…æ ¸æºç 
      - name: æ‹‰å–å†…æ ¸æºç 
        run: |
          set -euo pipefail
          # å…‹éš†æŒ‡å®šå†…æ ¸æºç ä»“åº“åˆ°æŒ‡å®šç›®å½•
          git clone --depth=1 --branch=${KERNEL_BRANCH} \
            https://github.com/${KERNEL_REPO}.git ${KERNEL_SOURCE_DIR}
          # æ ¡éªŒæºç æ‹‰å–ç»“æœ
          if [ ! -d "${KERNEL_BUILD_DIR}" ]; then
            echo "å†…æ ¸æºç æ‹‰å–å¤±è´¥ï¼Œç¼–è¯‘ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          echo "å†…æ ¸æºç æ‹‰å–å®Œæˆï¼Œç›®å½•ï¼š${KERNEL_BUILD_DIR}"

      # æ­¥éª¤6ï¼šé…ç½®Python3è·¯å¾„
      - name: é…ç½®Python3çš„è·¯å¾„
        run: |
          set -euo pipefail

          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          [ -d "${PYTHON3_PREBUILTS_PATH}" ] || mkdir -p "${PYTHON3_PREBUILTS_PATH}"

          # è·å–ç³»ç»ŸPython3å®é™…è·¯å¾„
          SYSTEM_PYTHON3=$(which python3)

          # å¼ºåˆ¶åˆ›å»º/è¦†ç›–Python3è½¯é“¾æ¥
          ln -sf "${SYSTEM_PYTHON3}" "${PYTHON3_PREBUILTS_PATH}/python3"

          # æ ¡éªŒè½¯é“¾æ¥æœ‰æ•ˆæ€§
          if [ ! -x "${PYTHON3_PREBUILTS_PATH}/python3" ]; then
            echo "Python3è½¯é“¾æ¥åˆ›å»ºå¤±è´¥,è·¯å¾„æ— æ•ˆï¼š${PYTHON3_PREBUILTS_PATH}/python3"
            exit 1
          fi
          echo "Python3è½¯é“¾æ¥é…ç½®å®Œæˆ,æŒ‡å‘ï¼š${SYSTEM_PYTHON3}"
          BAZEL_TARGET_PATH="${KERNEL_BUILD_DIR}/prebuilts/bazel/linux-x86_64/"
          mkdir -p ${BAZEL_TARGET_PATH}
          curl -L https://github.com/bazelbuild/bazel/releases/download/9.0.0rc6/bazel-9.0.0rc6-linux-x86_64 -o ${BAZEL_TARGET_PATH}/bazel
          chmod +x ${BAZEL_TARGET_PATH}/bazel

      # æ­¥éª¤7ï¼šç¼–è¯‘å†…æ ¸
      - name: ç¼–è¯‘å†…æ ¸
        run: |
          set -euo pipefail
          # è¿›å…¥å†…æ ¸ç¼–è¯‘ç›®å½•
          cd ${KERNEL_BUILD_DIR}
          # æ‰§è¡ŒBazelç¼–è¯‘
          bazelisk build //kernel:kernel_aarch64 \
            --verbose_failures \
            --sandbox_debug \
            --jobs=$(nproc)
          echo "ä½ è¯´è¿™ç©æ„è°ç ”ç©¶çš„ï¼Ÿ"

      # æ­¥éª¤8ï¼šéªŒè¯ç¼–è¯‘äº§ç‰©
      - name: éªŒè¯ç¼–è¯‘äº§ç‰©
        run: |
          set -euo pipefail
          # æŸ¥æ‰¾ç¼–è¯‘åçš„img/dtbæ–‡ä»¶
          ARTIFACTS=$(find ${BAZEL_OUTPUT_DIR} -name '*.img' -o -name '*.dtb')        #ä½†æ˜¯ä¸å¯¹å•Šï¼Ÿæˆ‘ç¼–è¯‘çš„ä¸æ˜¯åªæœ‰å†…æ ¸å—ï¼Ÿ
          if [ -z "${ARTIFACTS}" ]; then                                              #ç®—äº†å°±è¿™æ ·å†™å§
            echo "æœªæ‰¾åˆ°ç¼–è¯‘åçš„å†…æ ¸é•œåƒ/è®¾å¤‡æ ‘æ–‡ä»¶"
            exit 1
          fi
          # æ‰“å°äº§ç‰©åˆ—è¡¨ï¼Œä¾¿äºæ ¸å¯¹
          echo "ç¼–è¯‘äº§ç‰©éªŒè¯é€šè¿‡ï¼Œäº§ç‰©åˆ—è¡¨ï¼š"
          echo "${ARTIFACTS}"

      # æ­¥éª¤9ï¼šä¸Šä¼ ç¼–è¯‘äº§ç‰©
      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        if: ${{ success() }}  # ä»…ç¼–è¯‘/éªŒè¯æˆåŠŸæ—¶ä¸Šä¼ 
        with:
          name: oneplus-mt6897-kernel-${{ github.sha }}
          path: |
            ${BAZEL_OUTPUT_DIR}/**/*.img
            ${BAZEL_OUTPUT_DIR}/**/*.dtb
          retention-days: 7  # äº§ç‰©ä¿ç•™7å¤©ï¼Œå¯æ ¹æ®éœ€æ±‚è°ƒæ•´

      # æ­¥éª¤10ï¼šæ¸…ç†ä¸´æ—¶æ–‡ä»¶
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: ${{ success() }}  # å‚»é€¼aiå†™çš„'always',tmdå‰é¢ç¼–è¯‘æœ‰ç‚¹é—®é¢˜å°±æ‰§è¡Œ,éº»ç—¹ï¼#
        run: |
          set -euo pipefail
          # æ¸…ç†ç¼“å­˜å’Œç¼–è¯‘ä¸´æ—¶æ–‡ä»¶
          rm -rf ~/.ccache ~/.cache/bazel
          rm -rf ${BAZEL_OUTPUT_DIR}
          echo "ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"