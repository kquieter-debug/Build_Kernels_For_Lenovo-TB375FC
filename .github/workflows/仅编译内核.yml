name: 仅编译内核
on:
  workflow_dispatch:    #手动触发编译

env:
  KERNEL_REPO: "https://github.com/kquieter-debug/android_kernel_oneplus_mt6897.git"      # 内核仓库位置
  KERNEL_BRANCH: "oneplus/mt6897_v_15.0.0_oneplus_pad"
  DIST_DIR: "${{ github.workspace }}/out/dist"  # 编译输出目录
  RUST_VERSION: "1.70.0"      # Rust 版本声明

jobs:
  build_kernel:
    runs-on: ubuntu-22.04
    timeout-minutes: 120       # 设置超时时间
    steps:
      - name: 安装依赖
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y \
            git python3 python3-pip openjdk-17-jdk flex bison bc \
            libssl-dev libelf-dev repo curl wget zip unzip \
            ninja-build pkg-config libc6-dev-i386 \
            clang llvm lld make gcc-aarch64-linux-gnu
          # 清理缓存，避免依赖冲突
          sudo apt autoremove -y && sudo apt clean

      - name: 安装 Rust 编译链（适配 Android GKI）
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-linux-android
          components: rust-src, rustfmt, clippy
          
      - name: 配置 Rust 环境
        run: |
          echo "RUSTC=$(which rustc)" >> $GITHUB_ENV
          echo "CARGO=$(which cargo)" >> $GITHUB_ENV
          echo "RUST_TARGET_PATH=$(rustc --print sysroot)/lib/rustlib/src/rust/library/std/src/lib.rs" >> $GITHUB_ENV
          # 验证 Rust 安装
          rustc --version
          cargo --version

      - name: 拉取内核源码
        run: |
          mkdir -p ${{ github.workspace }}/kernel
          git clone --depth=1 --branch=${{ env.KERNEL_BRANCH }} ${{ env.KERNEL_REPO }} ${{ github.workspace }}/kernel
          cd ${{ github.workspace }}/kernel
          # 检查分支是否正确
          git branch -v

      - name: 安装 Bazelisk（适配内核的 Bazel 版本）
        run: |
          curl -LO https://github.com/bazelbuild/bazelisk/releases/latest/download/bazelisk-linux-amd64
          chmod +x bazelisk-linux-amd64
          sudo mv bazelisk-linux-amd64 /usr/local/bin/bazel
          # 验证 Bazel
          bazel --version

      - name: 编译内核（启用 Rust 支持）
        run: |
          cd ${{ github.workspace }}/kernel
          # 创建输出目录
          mkdir -p ${{ env.DIST_DIR }}
          # 编译命令：启用 Rust，指定 aarch64 架构，输出到指定目录
          tools/bazel run //common:kernel_aarch64_dist \
            --define=rustc_path=${{ env.RUSTC }} \
            --define=cargo_path=${{ env.CARGO }} \
            --define=enable_rust=1 \
            --lto=thin \
            -- --destdir=${{ env.DIST_DIR }}
          # 验证编译产物
          ls -lh ${{ env.DIST_DIR }}

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: oneplus-pad-mt6897-kernel-${{ github.sha }}
          path: |
            ${{ env.DIST_DIR }}/*
            !${{ env.DIST_DIR }}/*.log  # 排除日志文件
          retention-days: 14  # 产物保留14天