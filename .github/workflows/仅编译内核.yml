#############################
#   Written by Muffin_Joe   #
#############################
#     I wrote this sh*t     #
#############################
#    AI真是写得一坨好石啊！   #
#############################
name: 仅编译内核

on:
  workflow_dispatch: # 手动触发工作流

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

      - name: 检出代码
        uses: actions/checkout@v3

      - name: 最大化构建空间
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 4096
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl build-essential git \
            openjdk-11-jdk \
            wget bison flex libssl-dev \
            unzip \
            python3 python3-pip python3-setuptools \
            build-essential \
            zlib1g-dev \
            libncurses5-dev libssl-dev libxml2-utils \
            bc                #怎么写成这样...

      - name: 拉取交叉编译链
        run: |
          git clone --depth 1 https://github.com/kdrag0n/proton-clang  # 拉取 Proton Clang 编译器
          export PATH=$PATH:~/proton-clang/bin  # 把 Proton Clang 添加到环境变量
          export CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- CLANG_TRIPLE=aarch64-linux-gnu-  # 设置交叉编译前缀


      - name: 拉取内核源码 
        run: |
          git clone -b oneplus/mt6897_b_16.0.0_nord_ce5 https://github.com/kquieter-debug/Kernel_Oneplus_MT6897.git oneplus_kernel
          echo "内核源码拉取完成"
          cd oneplus_kernel

      - name: 生成配置文件 && 使用 Clang 开始构建内核
        run: |
          make ARCH=arm64 CC=clang O=out lmi_defconfig
          make ARCH=arm64 CC=clang O=out -j12
            echo "内核编译完成"

      - name: 使用AnyKernel3打包内核
        run: |
          git clone --depth 1 https://github.com/AnyKernel/AnyKernel3.git
          cd AnyKernel3
          cp -f ${GITHUB_WORKSPACE}/oneplus_kernel/out/arch/arm64/boot/Image.gz-dtb ramdisk/
          cd ..
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' AnyKernel3/anykernel.sh						# 不检测设备的名称
          sed -i 's!BLOCK=/dev/block/platform/omap/omap_hsmmc.0/by-name/boot;!BLOCK=auto;!g' AnyKernel3/anykernel.sh	# 自动选择内核分区
          sed -i 's/IS_SLOT_DEVICE=0;/IS_SLOT_DEVICE=auto;/g' AnyKernel3/anykernel.sh
            zip -r9 ${GITHUB_WORKSPACE}/oneplus_kernel/oneplus_kernel_nord_ce5.zip AnyKernel3/*

      - name: 上传 AK3 打包的内核镜像
        uses: actions/upload-artifact@v4
        with:
          name: oneplus_kernel_nord_ce5.zip
          path: oneplus_kernel/oneplus_kernel_nord_ce5.zip

      - name: 清理构建产物
        run: |
          make ARCH=arm64 CC=clang O=out clean