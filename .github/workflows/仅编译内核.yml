name: ä»…ç¼–è¯‘å†…æ ¸

on:
  workflow_dispatch:    #æ‰‹åŠ¨è§¦å‘ç¼–è¯‘

env:
  KERNEL_REPO: "https://github.com/kquieter-debug/android_kernel_oneplus_mt6897.git"      # å†…æ ¸ä»“åº“ä½ç½®
  KERNEL_BRANCH: "oneplus/mt6897_v_15.0.0_oneplus_pad"
  DIST_DIR: "${{ github.workspace }}/out/dist"  # ç¼–è¯‘è¾“å‡ºç›®å½•
  RUST_VERSION: "1.70.0"      # Rust ç‰ˆæœ¬å£°æ˜

jobs:
  build_kernel:
    runs-on: ubuntu-22.04
    timeout-minutes: 120       # è®¾ç½®è¶…æ—¶æ—¶é—´
    steps:
      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y \
            git python3 python3-pip openjdk-17-jdk flex bison bc \
            libssl-dev libelf-dev repo curl wget zip unzip \
            ninja-build pkg-config libc6-dev-i386 \
            clang llvm lld make gcc-aarch64-linux-gnu \
            aarch64-linux-gnu-gcc
          # æ¸…ç†ç¼“å­˜ï¼Œé¿å…ä¾èµ–å†²çª
          sudo apt autoremove -y && sudo apt clean

      - name: å®‰è£… Rust ç¼–è¯‘é“¾ï¼ˆé€‚é… Android GKIï¼‰
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-linux-android
          components: rust-src, rustfmt, clippy
          
      - name: é…ç½® Rust ç¯å¢ƒ
        run: |
          echo "RUSTC=$(which rustc)" >> $GITHUB_ENV
          echo "CARGO=$(which cargo)" >> $GITHUB_ENV
          echo "RUST_TARGET_PATH=$(rustc --print sysroot)/lib/rustlib/src/rust/library/std/src/lib.rs" >> $GITHUB_ENV
          # éªŒè¯ Rust å®‰è£…
          rustc --version
          cargo --version

      - name: æ‹‰å–å†…æ ¸æºç 
        run: |
          mkdir -p ${{ github.workspace }}/kernel
          git clone --depth=1 --branch=${{ env.KERNEL_BRANCH }} ${{ env.KERNEL_REPO }} ${{ github.workspace }}/kernel
          cd ${{ github.workspace }}/kernel
          # æ£€æŸ¥åˆ†æ”¯æ˜¯å¦æ­£ç¡®
          git branch -v

      - name: æ‹‰å–Androidç¼–è¯‘å·¥å…·é“¾
        run: |
            # æ‹‰å–Androidå®˜æ–¹Clangå·¥å…·é“¾ï¼ˆé€‚é…Android 15ï¼‰
            mkdir -p ${{ github.workspace }}/toolchain
            curl -LO https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r498229b.tar.gz
            tar -xzf clang-r498229b.tar.gz -C ${{ github.workspace }}/toolchain
            # é…ç½®å·¥å…·é“¾ç¯å¢ƒå˜é‡
            echo "PATH=${{ github.workspace }}/toolchain/bin:$PATH" >> $GITHUB_ENV
            echo "CROSS_COMPILE=aarch64-linux-android-" >> $GITHUB_ENV
            echo "CC=clang" >> $GITHUB_ENV

        - name: ğŸ”¨ ç¼–è¯‘å†…æ ¸ï¼ˆä¼ ç»Ÿbuild.shæ–¹å¼ï¼‰
        run: |
            cd ${{ github.workspace }}/kernel
            # æŒ‡å®šè®¾å¤‡defconfigï¼ˆä¸€åŠ Pad mt6897å¯¹åº”çš„defconfigï¼‰
            export DEFCONFIG=defconfig
            # æ‰§è¡Œå†…æ ¸è‡ªå¸¦çš„build.shç¼–è¯‘
            ./build.sh $DEFCONFIG
            # ç¼–è¯‘å®Œæˆåï¼Œäº§ç‰©è¾“å‡ºåˆ°out/arch/arm64/boot/
            mkdir -p ${{ env.DIST_DIR }}
            cp out/arch/arm64/boot/Image.lz4-dtb ${{ env.DIST_DIR }}
            cp out/arch/arm64/boot/dtbo.img ${{ env.DIST_DIR }}
            cp -r out/modules ${{ env.DIST_DIR }}
          # éªŒè¯ç¼–è¯‘äº§ç‰©
          ls -lh ${{ env.DIST_DIR }}

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: oneplus-pad-mt6897-kernel-${{ github.sha }}
          path: |
            ${{ env.DIST_DIR }}/*
            !${{ env.DIST_DIR }}/*.log  # æ’é™¤æ—¥å¿—æ–‡ä»¶
          retention-days: 14  # äº§ç‰©ä¿ç•™14å¤©