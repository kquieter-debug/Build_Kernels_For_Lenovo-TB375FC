#############################
#   Written by Muffin_Joe   #
#############################
#     I wrote this sh*t     #
#############################
name: ä»…ç¼–è¯‘å†…æ ¸

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ ¸å¿ƒä¿ç•™ï¼‰

# å·¥ä½œæµä»»åŠ¡é…ç½®
jobs:
  build:
    # è¿è¡Œç¯å¢ƒï¼šUbuntu 22.04
    runs-on: ubuntu-22.04
    # å…¨å±€ç¯å¢ƒå˜é‡ï¼šæå–å…³é”®è·¯å¾„ï¼Œé¿å…ç¡¬ç¼–ç ï¼Œä¾¿äºç»´æŠ¤
    env:
      KERNEL_REPO: kquieter-debug/android_kernel_modules_and_devicetree_oneplus_mt6897
      KERNEL_BRANCH: oneplus/mt6897_v_15.0.0_oneplus_pad
      KERNEL_SOURCE_DIR: ${{ github.workspace }}/kernel-source
      KERNEL_BUILD_DIR: ${{ github.workspace }}/kernel-source/kernel
      BAZEL_OUTPUT_DIR: ${{ github.workspace }}/kernel-source/bazel-out
      PYTHON3_PREBUILTS_PATH: ${{ github.workspace }}/kernel-source/kernel/prebuilts/build-tools/path/linux-x86/

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºGitHubä»“åº“ä»£ç ï¼ˆåŸºç¡€æ­¥éª¤ï¼‰
      - name: Checkout Repository
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šç¼“å­˜ccacheï¼ˆåŠ é€Ÿå†…æ ¸ç¼–è¯‘ï¼Œé¿å…é‡å¤ç¼–è¯‘ï¼‰
      - name: Cache ccache
        uses: actions/cache@v3
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      # æ­¥éª¤3ï¼šç¼“å­˜Bazelï¼ˆåŠ é€ŸBazelä¾èµ–ä¸‹è½½ï¼‰
      - name: Cache Bazel
        uses: actions/cache@v3
        with:
          path: ~/.cache/bazel
          key: ${{ runner.os }}-bazel-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-bazel-

      # æ­¥éª¤4ï¼šå®‰è£…å†…æ ¸ç¼–è¯‘ä¾èµ–ï¼ˆä¿®å¤ç¼“å­˜ã€å›ºå®šç‰ˆæœ¬ã€æ ¡éªŒå·¥å…·ï¼‰
      - name: Install Build Dependencies
        run: |
          set -euo pipefail  # å¼ºåŒ–é”™è¯¯æ£€æµ‹ï¼šæœªå®šä¹‰å˜é‡/ç®¡é“å¤±è´¥å‡ç»ˆæ­¢
          # ä¿®å¤aptç¼“å­˜ï¼Œå‡çº§åŸºç¡€åŒ…ï¼Œé¿å…ä¾èµ–å®‰è£…å¤±è´¥
          sudo apt update --fix-missing
          sudo apt upgrade -y
          # å®‰è£…å†…æ ¸ç¼–è¯‘æ ¸å¿ƒä¾èµ–ï¼ˆé™é»˜å®‰è£…ï¼Œé¿å…äº¤äº’ï¼‰
          sudo apt install -y -o DPkg::Options::="--force-confdef" \
            bc bison build-essential ccache curl flex \
            gcc-multilib git gnupg gperf \
            lib32ncurses5-dev lib32readline-dev lib32z1-dev \
            liblz4-tool libncurses5-dev libssl-dev \
            python3 python3-pip npm
          # å›ºå®šBazeliskç‰ˆæœ¬ï¼ˆé¿å…ç‰ˆæœ¬æ›´æ–°å¯¼è‡´å…¼å®¹é—®é¢˜ï¼‰
          sudo npm install -g @bazel/bazelisk@v1.18.0
          # æ ¡éªŒå…³é”®å·¥å…·ç‰ˆæœ¬ï¼Œä¾¿äºæ’æŸ¥ç‰ˆæœ¬å…¼å®¹é—®é¢˜
          echo "ğŸ” ç¯å¢ƒæ ¡éªŒ - Bazeliskç‰ˆæœ¬ï¼š$(bazelisk --version)"
          echo "ğŸ” ç¯å¢ƒæ ¡éªŒ - Python3ç‰ˆæœ¬ï¼š$(python3 --version)"
          echo "ğŸ” ç¯å¢ƒæ ¡éªŒ - GCCç‰ˆæœ¬ï¼š$(gcc --version | head -n1)"
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆï¼Œå·¥å…·ç‰ˆæœ¬æ ¡éªŒé€šè¿‡"

      # æ­¥éª¤5ï¼šæ‹‰å–å†…æ ¸æºç ï¼ˆæŒ‡å®šä»“åº“/åˆ†æ”¯ï¼‰
      - name: Pull Kernel Source Code
        run: |
          set -euo pipefail
          # å…‹éš†æŒ‡å®šå†…æ ¸æºç ä»“åº“åˆ°æŒ‡å®šç›®å½•
          git clone --depth=1 --branch=${KERNEL_BRANCH} \
            https://github.com/${KERNEL_REPO}.git ${KERNEL_SOURCE_DIR}
          # æ ¡éªŒæºç æ‹‰å–ç»“æœ
          if [ ! -d "${KERNEL_BUILD_DIR}" ]; then
            echo "âŒ å†…æ ¸æºç æ‹‰å–å¤±è´¥ï¼Œç¼–è¯‘ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… å†…æ ¸æºç æ‹‰å–å®Œæˆï¼Œç›®å½•ï¼š${KERNEL_BUILD_DIR}"

      # æ­¥éª¤6ï¼šé…ç½®Python3è·¯å¾„ï¼ˆä¿®å¤"æ–‡ä»¶ä¸å­˜åœ¨"é”™è¯¯ï¼‰
      - name: Set Up Python3 for Kernel Build
        run: |
          set -euo pipefail
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šé¿å…è½¯é“¾æ¥åˆ›å»ºå¤±è´¥ï¼‰
          [ -d "${PYTHON3_PREBUILTS_PATH}" ] || mkdir -p "${PYTHON3_PREBUILTS_PATH}"
          # è·å–ç³»ç»ŸPython3å®é™…è·¯å¾„
          SYSTEM_PYTHON3=$(which python3)
          # å¼ºåˆ¶åˆ›å»º/è¦†ç›–Python3è½¯é“¾æ¥ï¼ˆé¿å…é‡å¤è¿è¡ŒæŠ¥é”™ï¼‰
          ln -sf "${SYSTEM_PYTHON3}" "${PYTHON3_PREBUILTS_PATH}/python3"
          # æ ¡éªŒè½¯é“¾æ¥æœ‰æ•ˆæ€§
          if [ ! -x "${PYTHON3_PREBUILTS_PATH}/python3" ]; then
            echo "âŒ Python3è½¯é“¾æ¥åˆ›å»ºå¤±è´¥ï¼Œè·¯å¾„æ— æ•ˆï¼š${PYTHON3_PREBUILTS_PATH}/python3"
            exit 1
          fi
          echo "âœ… Python3è½¯é“¾æ¥é…ç½®å®Œæˆï¼ŒæŒ‡å‘ï¼š${SYSTEM_PYTHON3}"

      # æ­¥éª¤7ï¼šç¼–è¯‘å†…æ ¸ï¼ˆè¯¦ç»†æ—¥å¿—ï¼Œæå‡æ’æŸ¥æ•ˆç‡ï¼‰
      - name: Compile Kernel (aarch64)
        run: |
          set -euo pipefail
          # è¿›å…¥å†…æ ¸ç¼–è¯‘ç›®å½•
          cd ${KERNEL_BUILD_DIR}
          # æ‰§è¡ŒBazelç¼–è¯‘ï¼ˆè¯¦ç»†å¤±è´¥æ—¥å¿— + å¤šæ ¸ç¼–è¯‘åŠ é€Ÿï¼‰
          bazelisk build //kernel:kernel_aarch64 \
            --verbose_failures \
            --sandbox_debug \
            --jobs=$(nproc)
          echo "âœ… å†…æ ¸ç¼–è¯‘å®Œæˆ"

      # æ­¥éª¤8ï¼šéªŒè¯ç¼–è¯‘äº§ç‰©ï¼ˆé¿å…ä¸Šä¼ ç©ºæ–‡ä»¶ï¼‰
      - name: Verify Kernel Artifacts
        run: |
          set -euo pipefail
          # æŸ¥æ‰¾ç¼–è¯‘åçš„img/dtbæ–‡ä»¶
          ARTIFACTS=$(find ${BAZEL_OUTPUT_DIR} -name '*.img' -o -name '*.dtb')
          if [ -z "${ARTIFACTS}" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘åçš„å†…æ ¸é•œåƒ/è®¾å¤‡æ ‘æ–‡ä»¶"
            exit 1
          fi
          # æ‰“å°äº§ç‰©åˆ—è¡¨ï¼Œä¾¿äºæ ¸å¯¹
          echo "âœ… ç¼–è¯‘äº§ç‰©éªŒè¯é€šè¿‡ï¼Œäº§ç‰©åˆ—è¡¨ï¼š"
          echo "${ARTIFACTS}"

      # æ­¥éª¤9ï¼šä¸Šä¼ ç¼–è¯‘äº§ç‰©ï¼ˆä»…å‰åºæ­¥éª¤æˆåŠŸæ—¶æ‰§è¡Œï¼‰
      - name: Upload Kernel Artifacts
        uses: actions/upload-artifact@v4
        if: ${{ success() }}  # ä»…ç¼–è¯‘/éªŒè¯æˆåŠŸæ—¶ä¸Šä¼ 
        with:
          name: oneplus-mt6897-kernel-${{ github.sha }}
          path: |
            ${BAZEL_OUTPUT_DIR}/**/*.img
            ${BAZEL_OUTPUT_DIR}/**/*.dtb
          retention-days: 7  # äº§ç‰©ä¿ç•™7å¤©ï¼Œå¯æ ¹æ®éœ€æ±‚è°ƒæ•´

      # æ­¥éª¤10ï¼šæ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆæ— è®ºæˆè´¥éƒ½æ‰§è¡Œï¼Œé¿å…ç£ç›˜æº¢å‡ºï¼‰
      - name: Clean Up Build Env
        if: ${{ always() }}  # å¿½ç•¥å‰åºæ­¥éª¤ç»“æœï¼Œå¼ºåˆ¶æ‰§è¡Œ
        run: |
          set -euo pipefail
          # æ¸…ç†ç¼“å­˜å’Œç¼–è¯‘ä¸´æ—¶æ–‡ä»¶
          rm -rf ~/.ccache ~/.cache/bazel
          rm -rf ${BAZEL_OUTPUT_DIR}
          echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"