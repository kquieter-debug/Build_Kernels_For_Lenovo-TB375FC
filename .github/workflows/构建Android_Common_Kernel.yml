name: Build Android Kernel with Bazel (with Caching)

on:
  workflow_dispatch: # 手动触发工作流

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v2

      # 2. 安装必要的工具 (Bazel 和 repo)
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl \
            git \
            openjdk-11-jdk \
            wget \
            unzip \
            python3 \
            python3-pip \
            python3-setuptools \
            build-essential \
            ccache \
            zlib1g-dev \
            libncurses5-dev \
            libssl-dev \
            libxml2-utils \
            bc

      # 3. 安装 Bazel
      - name: Install Bazel
        run: |
          curl -fsSL https://bazel.build/bazel-release.pub.gpg | gpg --dearmor >bazel-archive-keyring.gpg
          sudo mv bazel-archive-keyring.gpg /usr/share/keyrings
          sudo apt update && sudo apt install apt-transport-https
          sudo apt update && sudo apt install bazel
          sudo apt update && sudo apt full-upgrade
          echo "Bazel installed."

      # 4. 安装 repo 工具
      - name: Install repo tool
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH=~/bin:$PATH

      # 5. 克隆内核源码
      - name: Initialize repo and sync the kernel
        run: |
          mkdir android_kernel
          cd android_kernel
          repo init -u https://android.googlesource.com/kernel/common.git -b a14-6.1
          repo sync -j$(nproc)

      # 6. 配置内核 (使用通用内核配置)
      - name: Configure kernel
        run: |
          cd android_kernel
          # 使用 a14-6.1 配置文件
          make ARCH=arm64 a14_6_1_defconfig

      # 7. 配置 Bazel 缓存
      - name: Cache Bazel build and dependencies
        uses: actions/cache@v2
        with:
          # 使用 Bazel 缓存目录
          path: |
            ~/.cache/bazel
            ~/.bazel-<user>-local
            android_kernel/.bazel-out
          key: ${{ runner.os }}-bazel-${{ hashFiles('**/*.bazel*') }}
          restore-keys: |
            ${{ runner.os }}-bazel-

      # 8. 使用 Bazel 构建内核
      - name: Build kernel with Bazel
        run: |
          cd android_kernel
          # 使用 Bazel 构建内核
          bazel build //kernel:kernel_image

      # 9. 保存构建结果
      - name: Save kernel image
        uses: actions/upload-artifact@v2
        with:
          name: kernel-image
          path: android_kernel/kernel/arch/arm64/boot/Image.gz-dtb
