#############################
#   Written by Muffin_Joe   #
#############################
#     I wrote this sh*t     #
#############################
#    AI真是写得一坨好石啊！   #
#############################
name: 构建谷歌主线内核

on:
  workflow_dispatch: # 手动触发工作流

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

      - name: 检出代码
        uses: actions/checkout@v3

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl \
            git \
            openjdk-11-jdk \
            wget \
            unzip \
            python3 \
            python3-pip \
            python3-setuptools \
            build-essential \
            ccache \
            zlib1g-dev \
            libncurses5-dev \
            libssl-dev \
            libxml2-utils \
            bc                #怎么写成这样...

      - name: 安装 Bazel
        run: |
          sudo apt install curl gnupg
          curl https://bazel.build/bazel-release.pub.gpg | sudo apt-key add -
          echo "deb [arch=amd64] https://storage.googleapis.com/bazel-apt stable jdk1.8" | sudo tee /etc/apt/sources.list.d/bazel.list
          sudo apt update && sudo apt install bazel
          sudo apt update && sudo apt full-upgrade

      # 移除了「安装 repo 工具」步骤
      # 移除了「初始化 repo 并同步内核」步骤
      # 新增：直接克隆谷歌主线内核仓库（替代 repo 同步逻辑）
      - name: 克隆谷歌主线内核源码
        run: |
          mkdir android_kernel
          cd android_kernel
          git clone https://android.googlesource.com/kernel/common.git .
          git checkout android-mainline

      - name: 配置内核
        run: |
          cd android_kernel
          # 使用 Mainline 配置文件
          make ARCH=arm64 defconfig               #怎么好像都叫defconfig?

      - name: 缓存 Bazel 构建和依赖
        uses: actions/cache@v3
        with:
          # 使用 Bazel 缓存目录
          path: |
            ~/.cache/bazel
            ~/.bazel-<user>-local
            android_kernel/.bazel-out
          key: ${{ runner.os }}-bazel-${{ hashFiles('**/*.bazel*') }}
          restore-keys: |
            ${{ runner.os }}-bazel-

      - name: 使用 Bazel 构建内核
        run: |
          cd android_kernel
          # 使用 Bazel 构建内核
          bazel build //kernel:kernel_image

      - name: 上传结果
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: android_kernel/kernel/arch/arm64/boot/Image.gz-dtb